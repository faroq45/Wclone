<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* Highlight selected user */
    #users li.selected {
      background-color: #cce5ff;
      font-weight: bold;
    }
    #currentChat {
      font-size: 0.9em;
      color: #444;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div style="display: flex; gap: 20px;">

  <!-- Chat Section -->
  <div class="chat-container">
    <h2>Welcome <%= username %>!</h2>
    <a href="/logout">Logout</a>

    <!-- Current Chat Info -->
    <div id="currentChat">(Public Chat)</div>

    <!-- Messages -->
    <div id="messages">
      <% messages.forEach(m => { %>
        <p class="<%= m.sender === username ? 'self' : 'other' %>" data-time="<%= m.createdAt.toISOString() %>">
          <b><%= m.sender %>:</b> <%= m.text %> 
          <span class="time"></span>
        </p>
      <% }) %>
    </div>

    <!-- Typing Preview -->
    <div id="typingPreview" style="font-size:0.85em; color:#777; margin-top:5px;"></div>

    <!-- Input -->
    <form id="chatForm">
      <input id="msgInput" type="text" placeholder="Type message..." required>
      <button type="submit">Send</button>
    </form>
  </div>

  <!-- Online Users -->
  <div class="chat-container" style="width: 200px;">
    <h3>Online Users</h3>
    <ul id="users"></ul>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const form = document.getElementById("chatForm");
  const input = document.getElementById("msgInput");
  const messagesDiv = document.getElementById("messages");
  const usersList = document.getElementById("users");
  const typingDiv = document.getElementById("typingPreview");
  const currentChatDiv = document.getElementById("currentChat");

  let currentRecipient = null; // private chat target

  // Format old message timestamps
  document.querySelectorAll("#messages p").forEach(p => {
    const iso = p.getAttribute("data-time");
    if (iso) {
      const time = new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      p.querySelector(".time").textContent = time;
    }
  });

  // Typing preview
  input.addEventListener("input", () => {
    const text = input.value.trim();
    typingDiv.textContent = text ? `You: ${text}` : "";
  });

  // Select user for private chat
  usersList.addEventListener("click", (e) => {
    if (e.target.tagName === "LI" || e.target.closest("li")) {
      const li = e.target.closest("li");
      const selectedUser = li.textContent.trim();

      // Cannot chat with yourself
      if (selectedUser === "<%= username %>") {
        alert("You cannot chat with yourself!");
        return;
      }

      // Toggle selection
      usersList.querySelectorAll("li").forEach(el => el.classList.remove("selected"));
      li.classList.add("selected");

      currentRecipient = selectedUser;
      currentChatDiv.textContent = `Private chat with ${currentRecipient}`;
    }
  });

  // Send message
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    const msgData = {
      sender: "<%= username %>",
      text,
      recipient: currentRecipient // null = public
    };

    socket.emit("chat message", msgData);
    input.value = "";
    typingDiv.textContent = "";
  });

  // Receive messages
  socket.on("chat message", (msg) => {
    const p = document.createElement("p");
    const time = new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    if (msg.sender === "<%= username %>") p.classList.add("self");
    else p.classList.add("other");

    const privateTag = msg.recipient ? " (private)" : "";
    p.innerHTML = `<b>${msg.sender}${privateTag}:</b> ${msg.text} <span class="time">${time}</span>`;
    messagesDiv.appendChild(p);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // Register new user
  socket.emit("new user", "<%= username %>");

  // Update online users
  socket.on("updateUsers", (users) => {
    usersList.innerHTML = "";
    users.forEach(u => {
      const li = document.createElement("li");
      li.innerHTML = `<span class="dot"></span> ${u}`;
      if (u === currentRecipient) li.classList.add("selected");
      usersList.appendChild(li);
    });
  });
</script>
</body>
</html>
